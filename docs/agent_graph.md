# Agent Graph Documentation

This document describes the structure and flow of the primary agent graph defined in `src/agents/graph.ts`.

## Visual Diagram

The following diagram represents the nodes and edges of the compiled agent graph. The initial routing logic occurs in the conditional edge after the START node.

<!-- MERMAID_DIAGRAM_START -->
```mermaid
graph TD;
    START([Start]);
    documentRetrievalNode([documentRetrievalNode]);
    analysisPrepare([analysisPrepare]);
    analysisInterrupt([analysisInterrupt]);
    echoAgent([echoAgent]);
    END([End]);
    START -- "analyze" keyword --> documentRetrievalNode;
    START -- "echo" keyword --> echoAgent;
    START -- other --> END;
    documentRetrievalNode --> analysisPrepare;
    analysisPrepare -- has analysisOutput --> END;
    analysisPrepare -- no analysisOutput --> analysisInterrupt;
    analysisInterrupt --> analysisPrepare;
    echoAgent --> END;
```
<!-- MERMAID_DIAGRAM_END -->

## State (`AppState`)

The graph operates on a state object defined by the `AppState` interface.

*   `userInput`: The input provided by the user, used for initial routing and processed by agents.
*   `response`: Stores the latest response from the `echoAgent`.
*   `fileContents`: Holds the content of files relevant to the analysis task. (Note: This may be deprecated in the future in favor of `inputs`).
*   `inputs`: Holds a mapping of input file names (basenames) to their string content, populated by the `documentRetrievalNode`.
*   `inputDirectoryPath`: Stores the path to the directory from which input files should be read by `documentRetrievalNode`.
*   `analysisHistory`: Tracks the conversation turns between the user and the analysis agent.
*   `analysisOutput`: Stores the final output generated by the analysis agent upon approval.
*   `currentAnalysisQuery`: Holds the question posed by the analysis agent during an interrupt.

## Nodes

The graph consists of the following nodes:

*   **`START`**: The special entry point node.
*   **`documentRetrievalNode`**: Reads input files (`.txt`, `.md`) from the directory specified in `AppState.inputDirectoryPath` and populates `AppState.inputs` with their content (filename: content). Warns and skips unreadable files.
*   **`echoAgent`**: Simple agent for echoing input.
*   **`analysisPrepare`**: Handles analysis logic, LLM calls, state updates, and checks for completion. Reads inputs from `AppState.inputs`.
*   **`analysisInterrupt`**: Triggers the pause (`interrupt`) to wait for user input during analysis.
*   **`END`**: The special exit point node.

## Flow / Edges

The execution flow follows these connections:

1.  **`START` -> Conditional Routing**: The graph evaluates the initial `userInput`:
    *   If it contains analysis keywords -> `documentRetrievalNode` (which then proceeds to `analysisPrepare`).
    *   If it starts with "echo" -> `echoAgent`.
    *   Otherwise -> `END`.
2.  **`documentRetrievalNode` -> `analysisPrepare`**: After `documentRetrievalNode` retrieves input files (populating `AppState.inputs`), it transitions to `analysisPrepare`.
3.  **`analysisPrepare` -> `analysisInterrupt` (Conditional)**: If `analysisPrepare` completes *without* generating a final `analysisOutput`, it transitions to `analysisInterrupt`.
4.  **`analysisPrepare` -> `END` (Conditional)**: If `analysisPrepare` completes *with* a final `analysisOutput` (e.g., solution approved or an error like missing inputs occurred), the graph terminates.
5.  **`analysisInterrupt` -> `analysisPrepare`**: After resuming from an interrupt, execution always returns to `analysisPrepare` to process the user's input.
6.  **`echoAgent` -> `END`**: After the `echoAgent` completes, the graph always terminates. 